<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PicAgent - æ™ºèƒ½å›¾ç‰‡ç”Ÿæˆå·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 222.2 47.4% 11.2%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 222.2 84% 4.9%;
            --radius: 0.5rem;
        }
        
        * {
            border-color: hsl(var(--border));
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        }

        .terminal-container {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            overflow: hidden;
        }


        .drag-active {
            border-color: rgb(59 130 246);
            background-color: rgb(239 246 255);
        }

        .checkbox-custom {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.25rem;
            background-color: white;
            cursor: pointer;
            position: relative;
        }

        .checkbox-custom:checked {
            background-color: #0f172a;
            border-color: #0f172a;
        }

        .checkbox-custom:checked::after {
            content: 'âœ“';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.875rem;
        }

        .case-item.selected {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }

        .case-item.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .case-item {
            position: relative;
        }

        /* å›¾ç‰‡åº“ç½‘æ ¼å®¹å™¨ç”± Tailwind ç±»æä¾›ï¼Œè¿™é‡Œæ— éœ€é¢å¤–å¸ƒå±€æ ·å¼ */
        .results-gallery {}

        .results-gallery img {
            width: 100%;
            height: auto;
            display: block; /* ç§»é™¤è¡Œå†…å…ƒç´ åŸºçº¿ç©ºéš™ï¼Œé¿å…åº•éƒ¨ç•™ç™½ */
            border-radius: 0.5rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .results-gallery img:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* å›¾ç‰‡åº“å“åº”å¼ç”± Tailwind æ …æ ¼ç±»æ§åˆ¶ */

        /* æ¡ˆä¾‹å¡ç‰‡åŸºç¡€æ ·å¼ä¼˜åŒ– */
        .case-item {
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 16px;
            display: flex;
            flex-direction: column;
            height: auto;
        }

        .case-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .case-item img {
            width: 100%;
            height: auto; /* ä¿æŒåŸå§‹æ¯”ä¾‹ */
            max-height: 180px; /* ç»Ÿä¸€ç¼©ç•¥å›¾ä¸Šé™ï¼Œé¿å…è¿‡å¤§ */
            display: block; /* é¿å…åŸºçº¿ç©ºéš™é€ æˆçš„åº•éƒ¨å¤šå‡ºä¸€æˆª */
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .case-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
            font-size: 0.95rem;
            line-height: 1.3;
            flex-shrink: 0;
        }

        .case-description {
            color: #6b7280;
            line-height: 1.4;
            font-size: 0.85rem;
        }

        /* çœŸæ­£çš„ç€‘å¸ƒæµå¸ƒå±€ - CSS Columns æ–¹æ¡ˆ */
        .cases-grid {
            column-width: 280px;
            column-gap: 1rem;
            column-fill: balance;
        }

        .case-item {
            break-inside: avoid; /* é˜²æ­¢å¡ç‰‡è¢«åˆ—åˆ†å‰² */
            page-break-inside: avoid; /* å…¼å®¹æ€§ */
            margin-bottom: 1rem;
            display: inline-block; /* ç¡®ä¿å®Œæ•´æ€§ */
            width: 100%;
            box-sizing: border-box;
        }

        /* ç°ä»£CSSé«˜åº¦ä¼˜åŒ– */
        .app-container {
            height: 100vh;
            height: 100dvh; /* åŠ¨æ€è§†çª—é«˜åº¦ï¼Œæ”¯æŒç§»åŠ¨ç«¯ */
            display: flex;
            flex-direction: column;
        }

        .app-header {
            flex-shrink: 0; /* å¤´éƒ¨ä¸ç¼©å° */
        }

        .main-content {
            flex: 1; /* è‡ªåŠ¨å æ®å‰©ä½™ç©ºé—´ */
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 1024px) {
            .main-content {
                flex-direction: row;
                align-items: flex-start; /* è®©å­å…ƒç´ ä»é¡¶éƒ¨å¼€å§‹ï¼Œè‡ªé€‚åº”é«˜åº¦ */
            }
        }

        /* å·¦ä¾§æ¡ˆä¾‹åº“åŒºåŸŸ */
        .cases-panel {
            flex: 1;
            min-height: 0;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 1024px) {
            .cases-panel {
                flex: 3;
                border-right: 1px solid #e5e7eb;
            }
        }

        /* å³ä¾§ç»ˆç«¯åŒºåŸŸ */
        .terminal-panel {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            border-top: 1px solid #e5e7eb;
        }

        @media (min-width: 1024px) {
            .terminal-panel {
                flex: 2;
                border-top: none;
            }
        }

        /* ç»ˆç«¯åŒºåŸŸä¼˜åŒ– */
        .terminal-container {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .terminal-body {
            flex: 1;
            overflow: hidden;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .cases-grid {
                column-width: 250px;
                column-gap: 0.75rem;
            }

            .case-item {
                padding: 12px;
                margin-bottom: 0.75rem;
            }

            .case-item img {
                height: auto; /* å°å±ä¿æŒåŸå§‹æ¯”ä¾‹ */
                max-height: 120px; /* å°å±ä¸Šé™æ›´å° */
            }

            .case-title {
                font-size: 0.9rem;
            }

            .case-description {
                font-size: 0.8rem;
            }
        }

        /* å¹³æ¿ç«¯ä¼˜åŒ– */
        @media (min-width: 768px) and (max-width: 1024px) {
            .cases-grid {
                column-width: 260px;
                column-gap: 1rem;
            }

            .case-item img {
                height: auto; /* å¹³æ¿ä¿æŒåŸå§‹æ¯”ä¾‹ */
                max-height: 140px; /* å¹³æ¿ä¸Šé™ */
            }
        }


        /* å¤§å±å¹•ä¼˜åŒ– */
        @media (min-width: 1280px) {
            .cases-grid {
                column-width: 300px;
                column-gap: 1.25rem;
            }

            .case-item img {
                height: auto; /* å¤§å±ä¿æŒåŸå§‹æ¯”ä¾‹ */
                max-height: 180px; /* å¤§å±ä¸Šé™ */
            }

            .case-title {
                font-size: 1rem;
            }

            .case-description {
                font-size: 0.875rem;
            }
        }

        /* æ»šåŠ¨ä¼˜åŒ– */
        .cases-panel {
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }

        .cases-panel::-webkit-scrollbar {
            width: 6px;
        }

        .cases-panel::-webkit-scrollbar-track {
            background: transparent;
        }

        .cases-panel::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }

        .cases-panel::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }

        /* å“åº”å¼éšè—å’Œæ˜¾ç¤º */
        .mobile-hidden {
            display: none;
        }

        @media (min-width: 640px) {
            .mobile-hidden {
                display: block;
            }
        }

        /* ç§»åŠ¨ç«¯ç‰¹æ®Šä¼˜åŒ– */
        @media (max-width: 1023px) {
            .cases-panel {
                flex: 3; /* ç›¸å¯¹æƒé‡3 */
            }

            .terminal-panel {
                flex: 2; /* ç›¸å¯¹æƒé‡2 */
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="app-container">
        <!-- Header -->
        <div class="app-header bg-white border-b">
            <div class="px-4 lg:px-6 py-4">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                    <h1 class="text-xl lg:text-2xl font-semibold text-gray-900">å°é¢å·¥ä½œç«™</h1>
                    <div class="flex items-center space-x-2 lg:space-x-3">
                        <span class="text-sm text-gray-600 hidden sm:inline">MCP:</span>
                        <span id="mcp-status-badge" class="px-2 lg:px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">æœªå°±ç»ª</span>
                        <a href="/mcp" class="px-3 lg:px-4 py-1.5 bg-white border border-gray-300 text-gray-900 rounded-lg hover:bg-gray-50 transition-colors text-sm">
                            âš™ï¸ ç®¡ç†
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel: Cases Library -->
            <div class="cases-panel">
                <div class="p-4 lg:p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <span class="text-xl mr-2">ğŸ“š</span>
                            <h2 class="text-lg font-semibold text-gray-900">æ¡ˆä¾‹åº“</h2>
                        </div>
                    </div>

                    <!-- Cases Grid - å“åº”å¼ç½‘æ ¼ -->
                    <div id="cases-grid" class="cases-grid mb-6">
                        <!-- Cases will be loaded dynamically -->
                    </div>

                    <!-- User Requirements -->
                    <div class="border-t pt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·éœ€æ±‚æè¿°</label>
                        <textarea
                            id="user-requirements"
                            rows="4"
                            placeholder="è¯·æè¿°æ‚¨çš„å…·ä½“éœ€æ±‚ï¼Œæ¯”å¦‚ï¼šé£æ ¼åå¥½ã€é¢œè‰²è¦æ±‚ã€ç‰¹æ®Šå…ƒç´ ç­‰..."
                            class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        ></textarea>

                        <div class="flex justify-end mt-4">
                            <button
                                id="agent-generate-btn"
                                class="px-6 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors font-medium"
                            >
                                ğŸ¨ ç”Ÿæˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Terminal -->
            <div class="terminal-panel">
                <div class="p-4 lg:p-6 flex-1 flex flex-col">
                    <div class="flex items-center mb-4">
                        <span class="text-xl mr-2">ğŸ’»</span>
                        <h2 class="text-lg font-semibold text-gray-900">ç»ˆç«¯</h2>
                        <div class="ml-auto flex items-center space-x-2">
                            <span class="text-xs text-gray-500">Claude</span>
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        </div>
                    </div>
                    <div class="terminal-container flex-1">
                        <div class="bg-gray-100 px-4 py-2 flex items-center justify-between border-b border-gray-200">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            </div>
                            <div class="flex items-center gap-4 min-w-0">
                                <span class="text-xs text-gray-600 whitespace-nowrap">Claude Terminal</span>
                                <div class="hidden sm:flex items-center gap-2">
                                    <input id="global-output-dir-input" type="text" placeholder="/Users/you/Pictures" class="text-xs px-2 py-1 border rounded w-56" />
                                    <button id="save-global-output-dir" class="text-xs px-2 py-1 border rounded hover:bg-gray-50">ä¿å­˜</button>
                                </div>
                            </div>
                        </div>
                        <div class="terminal-body p-2">
                            <div id="terminal"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Section: Results Gallery -->
        <div class="bg-white border-t">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <span class="text-xl mr-2">ğŸ–¼ï¸</span>
                        <h2 class="text-lg font-semibold text-gray-900">Agentç”Ÿæˆç»“æœ</h2>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button id="refresh-gallery" class="px-3 py-1.5 text-sm border rounded-lg hover:bg-gray-50 transition-colors">
                            ğŸ”„ åˆ·æ–°
                        </button>
                        <button id="open-folder" class="px-3 py-1.5 text-sm border rounded-lg hover:bg-gray-50 transition-colors">
                            ğŸ“ æ‰“å¼€æ–‡ä»¶å¤¹
                        </button>
                    </div>
                </div>

                <!-- Image Gallery -->
                <div id="results-gallery" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 results-gallery">
                    <!-- Results will be loaded here automatically -->
                    <div class="text-center text-gray-500 col-span-full py-8">
                        <span class="text-4xl mb-2 block">ğŸ¨</span>
                        <p class="text-sm">ç”Ÿæˆçš„ç»“æœå°†è‡ªåŠ¨æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                        <p class="text-xs text-gray-400 mt-1">æŒ‰æ—¶é—´æ’åºï¼Œæœ€æ–°çš„åœ¨å‰</p>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- MCP Manager Modal -->
        <div id="mcp-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-hidden">
                <div class="px-6 py-4 border-b">
                    <h3 class="text-lg font-semibold">MCP é…ç½®ç®¡ç†</h3>
                </div>
                <div class="p-6 overflow-y-auto max-h-[70vh]">
                    <!-- MCP Configurations -->
                    <div class="space-y-6">
                        <!-- APICore Configuration -->
                        <div class="border rounded-lg p-4">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-medium flex items-center">
                                    <span class="text-xl mr-2">ğŸ“¦</span>
                                    jimeng-apicore
                                </h4>
                                <span id="apicore-status" class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">æœªæ£€æµ‹</span>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                    <input 
                                        type="password" 
                                        id="apicore-api-key" 
                                        placeholder="sk-xxxxxxxxxxxxxxxx"
                                        class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                    <p class="mt-1 text-xs text-gray-500">
                                        è·å–API Key: <a href="https://api.apicore.ai" target="_blank" class="text-blue-600 hover:underline">https://api.apicore.ai</a>
                                    </p>
                                </div>
                                <div class="text-xs text-gray-500">è¾“å‡ºç›®å½•ç”±é¦–é¡µé¡¶éƒ¨çš„â€œè¾“å‡ºç›®å½•â€ç»Ÿä¸€ç®¡ç†</div>
                                <div class="flex gap-2 mt-3">
                                    <button onclick="saveMCPConfig('apicore')" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors">
                                        ä¿å­˜é…ç½®
                                    </button>
                                    <button onclick="testMCPConfig('apicore')" class="px-3 py-1.5 border text-sm rounded hover:bg-gray-50 transition-colors">
                                        æµ‹è¯•è¿æ¥
                                    </button>
                                    <button onclick="installMCP('jimeng-apicore')" class="px-3 py-1.5 border text-sm rounded hover:bg-gray-50 transition-colors">
                                        å®‰è£…/æ›´æ–°
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- VolcEngine Configuration -->
                        <div class="border rounded-lg p-4">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-medium flex items-center">
                                    <span class="text-xl mr-2">ğŸ“¦</span>
                                    jimeng-volcengine
                                </h4>
                                <span id="volcengine-status" class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">æœªæ£€æµ‹</span>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                    <input 
                                        type="password" 
                                        id="volcengine-api-key" 
                                        placeholder="sk-xxxxxxxxxxxxxxxx"
                                        class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                    <p class="mt-1 text-xs text-gray-500">
                                        è·å–API Key: <a href="https://console.volcengine.com" target="_blank" class="text-blue-600 hover:underline">https://console.volcengine.com</a>
                                    </p>
                                </div>
                                <div class="text-xs text-gray-500">è¾“å‡ºç›®å½•ç”±é¦–é¡µé¡¶éƒ¨çš„â€œè¾“å‡ºç›®å½•â€ç»Ÿä¸€ç®¡ç†</div>
                                <div class="flex gap-2 mt-3">
                                    <button onclick="saveMCPConfig('volcengine')" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors">
                                        ä¿å­˜é…ç½®
                                    </button>
                                    <button onclick="testMCPConfig('volcengine')" class="px-3 py-1.5 border text-sm rounded hover:bg-gray-50 transition-colors">
                                        æµ‹è¯•è¿æ¥
                                    </button>
                                    <button onclick="installMCP('jimeng-volcengine')" class="px-3 py-1.5 border text-sm rounded hover:bg-gray-50 transition-colors">
                                        å®‰è£…/æ›´æ–°
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <h5 class="font-medium text-sm text-gray-700 mb-2">ğŸ“Œ é…ç½®è¯´æ˜</h5>
                        <ol class="text-xs text-gray-600 space-y-1 list-decimal list-inside">
                            <li>ç‚¹å‡»"å®‰è£…/æ›´æ–°"å®‰è£…å¯¹åº”çš„MCP</li>
                            <li>è¾“å…¥ API Keyï¼ˆè¾“å‡ºç›®å½•åœ¨é¦–é¡µé¡¶éƒ¨ç»Ÿä¸€è®¾ç½®ï¼‰</li>
                            <li>ç‚¹å‡»"ä¿å­˜é…ç½®"ä¿å­˜åˆ°æœ¬åœ°é…ç½®æ–‡ä»¶</li>
                            <li>ç‚¹å‡»"æµ‹è¯•è¿æ¥"éªŒè¯é…ç½®æ˜¯å¦æ­£ç¡®</li>
                            <li>é…ç½®æˆåŠŸåå³å¯ä½¿ç”¨å³æ¢¦AIç”Ÿæˆå›¾ç‰‡</li>
                        </ol>
                    </div>
                </div>
                <div class="px-6 py-4 border-t flex justify-between">
                    <button id="mcp-view-config" class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition-colors text-sm">
                        æŸ¥çœ‹é…ç½®æ–‡ä»¶
                    </button>
                    <div class="flex space-x-3">
                        <button id="mcp-close-btn" class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition-colors">
                            å…³é—­
                        </button>
                        <button id="mcp-refresh-btn" class="px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors">
                            åˆ·æ–°çŠ¶æ€
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="/js/covers-data.js"></script>
    <script src="/js/app.js"></script>
    <script src="/js/terminal.js"></script>
    <script src="/js/gui-config.js"></script>
    <script src="/js/mcp-manager.js"></script>
    <script>
        // ç»Ÿä¸€æ•°æ®æºé…ç½®
        const STORAGE_KEY = 'coverTemplatesData';
        let selectedCase = '1'; // Default selection
        
        // è·å–æ¡ˆä¾‹æ•°æ®ï¼ˆç›´æ¥ä½¿ç”¨covers-data.jsæ–‡ä»¶ï¼‰
        function getCoverTemplates() {
            // ç›´æ¥ä½¿ç”¨covers-data.jsä¸­çš„æ•°æ®
            return window.coverTemplates || {};
        }


        // åŠ¨æ€ç”Ÿæˆæ¡ˆä¾‹ç½‘æ ¼
        function generateCasesGrid() {
            const coverTemplates = getCoverTemplates(); // ä½¿ç”¨æœ€æ–°æ•°æ®
            const casesGrid = document.getElementById('cases-grid');
            
            let html = '';
            Object.keys(coverTemplates).forEach((id, index) => {
                const template = coverTemplates[id];
                
                html += `
                    <div class="case-item cursor-pointer rounded-lg p-3" data-case="${id}">
                        <div class="rounded mb-2 flex items-center justify-center">
                            <img src="${template.coverImage}" alt="${template.name}" class="w-full h-auto object-contain rounded" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <span class="text-sm hidden">${id}</span>
                        </div>
                        <p class="text-xs text-gray-600 text-center">${template.name}</p>
                    </div>
                `;
            });
            
            casesGrid.innerHTML = html;
            
            // é‡æ–°ç»‘å®šäº‹ä»¶
            document.querySelectorAll('.case-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    document.querySelectorAll('.case-item').forEach(i => i.classList.remove('selected'));
                    e.currentTarget.classList.add('selected');
                    selectedCase = e.currentTarget.dataset.case;
                });
            });
            
            // è®¾ç½®é»˜è®¤é€‰æ‹©ï¼ˆé€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨æ¡ˆä¾‹ï¼‰
            const firstCase = Object.keys(coverTemplates)[0];
            if (firstCase) {
                selectedCase = firstCase;
                document.querySelector(`.case-item[data-case="${firstCase}"]`)?.classList.add('selected');
            }
        }
        
        // ä¸å†éœ€è¦ç›‘å¬localStorageï¼Œæ•°æ®ä»æœåŠ¡å™¨æ–‡ä»¶è¯»å–
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç›´æ¥ç”Ÿæˆæ¡ˆä¾‹ç½‘æ ¼ï¼Œä¸éœ€è¦åˆå§‹åŒ–localStorage
            generateCasesGrid();
        });


        // é˜²æ­¢é‡å¤æäº¤çš„æ ‡å¿—
        let isGenerating = false;
        
        // Agent generate button
        document.getElementById('agent-generate-btn').addEventListener('click', async () => {
            // é˜²æ­¢é‡å¤ç‚¹å‡»
            if (isGenerating) {
                console.log('æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }
            
            const userRequirements = document.getElementById('user-requirements').value.trim();
            const coverTemplates = getCoverTemplates(); // è·å–æœ€æ–°æ•°æ®
            const template = coverTemplates[selectedCase];
            
            if (!template) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæ¡ˆä¾‹');
                return;
            }
            
            // è®¾ç½®ç”ŸæˆçŠ¶æ€
            isGenerating = true;
            const btn = document.getElementById('agent-generate-btn');
            btn.disabled = true;
            btn.textContent = 'â³ ç”Ÿæˆä¸­...';
            
            // è§£æè¾“å‡ºç›®å½•ï¼ˆä»åç«¯è§£æå¥½çš„ç›®å½•è·å–ï¼‰
            let outputDir = '';
            try {
                const r = await fetch('/api/output-dir');
                const j = await r.json();
                if (j && j.outputDir) {
                    outputDir = j.outputDir;
                }
            } catch (e) {
                console.warn('æ— æ³•è·å–è¾“å‡ºç›®å½•ï¼Œå°†ç»§ç»­æ‰§è¡Œ:', e);
            }

            // ç”Ÿæˆä¸€ä¸ªç›®å½•å‘½ä»¤ï¼Œä¾›Agentæ‰§è¡Œï¼ˆæç¤ºç”¨é€”ï¼‰
            const dirCmd = outputDir ? `cd \"${outputDir}\"` : '';

            // å‘é€ç»™åç«¯
            if (window.socket) {
                window.socket.emit('jimeng:generate', {
                    prompt: template.prompt || '',
                    case: selectedCase,
                    userRequirements: userRequirements,
                    outputDir,
                    dirCmd
                });
            }
            
            // 5ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
            setTimeout(() => {
                isGenerating = false;
                btn.disabled = false;
                btn.textContent = 'ğŸ¨ ç”Ÿæˆ';
            }, 5000);
        });
        

        // Gallery refresh
        document.getElementById('refresh-gallery').addEventListener('click', () => {
            loadGalleryImages();
        });

        // Chat functionality removed - using cases library instead

        // Open folder
        document.getElementById('open-folder').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/open-folder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const result = await response.json();
                if (!result.success) {
                    console.error('Failed to open folder:', result.error);
                }
            } catch (error) {
                console.error('Error opening folder:', error);
            }
        });

        // Load gallery images from MCP output directory
        async function loadGalleryImages() {
            const gallery = document.getElementById('results-gallery');
            
            try {
                const response = await fetch(`/api/gallery`);
                const result = await response.json();
                const files = result.files || [];

                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆsuccess ä¸º falseï¼‰
                if (result && result.success === false) {
                    console.warn('Gallery error:', result.error, 'outputDir:', result.outputDir);
                    gallery.innerHTML = `
                        <div class="text-center text-gray-500 py-8 col-span-full">
                            <span class="text-4xl mb-2 block">âš ï¸</span>
                            <p class="text-sm">æ— æ³•åŠ è½½ç»“æœ</p>
                            <p class="text-xs text-gray-400 mt-1">${result.error || 'æœªçŸ¥é”™è¯¯'}</p>
                            <p class="text-xs text-gray-400 mt-2">è¾“å‡ºç›®å½•: ${result.outputDir || 'æœªé…ç½®'}</p>
                        </div>
                    `;
                    return;
                }

                if (files.length > 0) {
                    gallery.innerHTML = '';
                    gallery.className = 'grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 results-gallery';

                    // æ˜¾ç¤ºæ–‡ä»¶ï¼ˆå›¾ç‰‡æˆ–HTMLï¼‰
                    files.forEach(item => {
                        // ç»Ÿä¸€å®¹å™¨
                        const container = document.createElement('div');
                        container.className = 'relative group cursor-pointer';

                        if (item.type === 'image') {
                            const img = document.createElement('img');
                            img.src = item.url;
                            img.alt = item.name;
                            img.className = 'w-full object-contain rounded-lg';
                            img.loading = 'lazy';
                            container.appendChild(img);
                        } else if (item.type === 'html') {
                            // HTML æ–‡ä»¶å¡ç‰‡æ ·å¼
                            const card = document.createElement('div');
                            card.className = 'w-full rounded-lg border border-gray-200 p-3 flex items-center justify-between hover:border-blue-400 transition-colors bg-white';

                            const left = document.createElement('div');
                            left.className = 'flex items-center space-x-2 overflow-hidden';
                            const icon = document.createElement('span');
                            icon.textContent = 'ğŸŒ';
                            const name = document.createElement('span');
                            name.className = 'text-sm text-gray-700 truncate';
                            name.textContent = item.name;
                            left.appendChild(icon);
                            left.appendChild(name);

                            const openBtn = document.createElement('button');
                            openBtn.className = 'text-xs px-2 py-1 border rounded hover:bg-gray-50';
                            openBtn.textContent = 'æ‰“å¼€';

                            card.appendChild(left);
                            card.appendChild(openBtn);
                            container.appendChild(card);

                            // ç‚¹å‡»æ‰“å¼€
                            container.addEventListener('click', () => {
                                window.open(item.url, '_blank');
                            });
                        }

                        // æ—¶é—´æ ‡ç­¾
                        const timeLabel = document.createElement('div');
                        timeLabel.className = 'absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 rounded-b-lg opacity-0 group-hover:opacity-100 transition-opacity';
                        const date = new Date(item.mtime);
                        timeLabel.textContent = date.toLocaleString('zh-CN', {
                            month: 'numeric',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        container.appendChild(timeLabel);
                        gallery.appendChild(container);
                    });
                    
                    // æ˜¾ç¤ºè¾“å‡ºç›®å½•ä¿¡æ¯
                    const dirInfo = document.createElement('div');
                    dirInfo.className = 'text-center text-xs text-gray-500 mt-4 col-span-full';
                    dirInfo.textContent = `è¾“å‡ºç›®å½•: ${result.outputDir}`;
                    gallery.appendChild(dirInfo);
                } else if (result.files && result.files.length === 0) {
                    gallery.innerHTML = `
                        <div class="text-center text-gray-500 py-8 col-span-full">
                            <span class="text-4xl mb-2 block">ğŸ¨</span>
                            <p class="text-sm">æš‚æ— ç”Ÿæˆçš„ç»“æœ</p>
                            <p class="text-xs text-gray-400 mt-1">ç”Ÿæˆçš„ç»“æœå°†è‡ªåŠ¨æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                            <p class="text-xs text-gray-400 mt-2">è¾“å‡ºç›®å½•: ${result.outputDir || 'æœªé…ç½®'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error);
                gallery.innerHTML = `
                    <div class="text-center text-gray-500 py-8 col-span-full">
                        <span class="text-4xl mb-2 block">âŒ</span>
                        <p class="text-sm">åŠ è½½å›¾ç‰‡å¤±è´¥</p>
                        <p class="text-xs text-gray-400 mt-1">${error.message}</p>
                    </div>
                `;
            }
        }
        // é¡µé¢åŠ è½½æ—¶åŠ è½½å›¾ç‰‡
        async function updateOutputDirDisplay() {
            try {
                const r = await fetch('/api/output-dir');
                const j = await r.json();
                const input = document.getElementById('global-output-dir-input');
                if (input) {
                    input.value = (j && j.sources && j.sources.configOutputDir) ? j.sources.configOutputDir : (j.outputDir || '');
                    input.title = input.value;
                }
            } catch {}
        }

        loadGalleryImages();
        updateOutputDirDisplay();
        
        // Auto-refresh gallery every 10 seconds
        setInterval(() => { loadGalleryImages(); updateOutputDirDisplay(); }, 10000);

        // ä¿å­˜å…¨å±€è¾“å‡ºç›®å½•
        const saveBtn = document.getElementById('save-global-output-dir');
        if (saveBtn) {
            saveBtn.addEventListener('click', async () => {
                try {
                    const input = document.getElementById('global-output-dir-input');
                    const outputDir = input.value.trim();
                    const res = await fetch('/api/output-dir', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ outputDir })
                    });

                    const ct = res.headers.get('content-type') || '';
                    let j;
                    if (ct.includes('application/json')) {
                        j = await res.json();
                    } else {
                        const t = await res.text();
                        throw new Error(`æœåŠ¡å™¨è¿”å›éJSON: ${t.slice(0, 120)}...`);
                    }

                    if (!j.success) throw new Error(j.error || 'ä¿å­˜å¤±è´¥');
                    await updateOutputDirDisplay();
                    await loadGalleryImages();
                } catch (e) {
                    console.error('ä¿å­˜è¾“å‡ºç›®å½•å¤±è´¥:', e);
                    alert('ä¿å­˜è¾“å‡ºç›®å½•å¤±è´¥: ' + (e.message || e));
                }
            });
        }
    </script>
</body>
</html>
