<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PicAgent - 智能图片生成工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 222.2 47.4% 11.2%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 222.2 84% 4.9%;
            --radius: 0.5rem;
        }
        
        * {
            border-color: hsl(var(--border));
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        }

        .terminal-container {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            overflow: hidden;
        }


        .drag-active {
            border-color: rgb(59 130 246);
            background-color: rgb(239 246 255);
        }

        .checkbox-custom {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.25rem;
            background-color: white;
            cursor: pointer;
            position: relative;
        }

        .checkbox-custom:checked {
            background-color: #0f172a;
            border-color: #0f172a;
        }

        .checkbox-custom:checked::after {
            content: '✓';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.875rem;
        }

        .case-item.selected {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }

        .case-item.selected::after {
            content: '✓';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .case-item {
            position: relative;
        }

        /* 图片库网格容器由 Tailwind 类提供，这里无需额外布局样式 */
        .results-gallery {}

        .results-gallery img {
            width: 100%;
            height: auto;
            display: block; /* 移除行内元素基线空隙，避免底部留白 */
            border-radius: 0.5rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .results-gallery img:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* 图片库响应式由 Tailwind 栅格类控制 */

        /* 案例卡片基础样式优化 */
        .case-item {
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 16px;
            display: flex;
            flex-direction: column;
            height: auto;
        }

        .case-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .case-item img {
            width: 100%;
            height: auto; /* 保持原始比例 */
            max-height: 180px; /* 统一缩略图上限，避免过大 */
            display: block; /* 避免基线空隙造成的底部多出一截 */
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .case-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
            font-size: 0.95rem;
            line-height: 1.3;
            flex-shrink: 0;
        }

        .case-description {
            color: #6b7280;
            line-height: 1.4;
            font-size: 0.85rem;
        }

        /* 真正的瀑布流布局 - CSS Columns 方案 */
        .cases-grid {
            column-width: 280px;
            column-gap: 1rem;
            column-fill: balance;
        }

        .case-item {
            break-inside: avoid; /* 防止卡片被列分割 */
            page-break-inside: avoid; /* 兼容性 */
            margin-bottom: 1rem;
            display: inline-block; /* 确保完整性 */
            width: 100%;
            box-sizing: border-box;
        }

        /* 现代CSS高度优化 */
        .app-container {
            height: 100vh;
            height: 100dvh; /* 动态视窗高度，支持移动端 */
            display: flex;
            flex-direction: column;
        }

        .app-header {
            flex-shrink: 0; /* 头部不缩小 */
        }

        .main-content {
            flex: 1; /* 自动占据剩余空间 */
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 1024px) {
            .main-content {
                flex-direction: row;
                align-items: flex-start; /* 让子元素从顶部开始，自适应高度 */
            }
        }

        /* 左侧案例库区域 */
        .cases-panel {
            flex: 1;
            min-height: 0;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 1024px) {
            .cases-panel {
                flex: 3;
                border-right: 1px solid #e5e7eb;
            }
        }

        /* 右侧终端区域 */
        .terminal-panel {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            border-top: 1px solid #e5e7eb;
        }

        @media (min-width: 1024px) {
            .terminal-panel {
                flex: 2;
                border-top: none;
            }
        }

        /* 终端区域优化 */
        .terminal-container {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .terminal-body {
            flex: 1;
            overflow: hidden;
        }

        /* 移动端优化 */
        @media (max-width: 768px) {
            .cases-grid {
                column-width: 250px;
                column-gap: 0.75rem;
            }

            .case-item {
                padding: 12px;
                margin-bottom: 0.75rem;
            }

            .case-item img {
                height: auto; /* 小屏保持原始比例 */
                max-height: 120px; /* 小屏上限更小 */
            }

            .case-title {
                font-size: 0.9rem;
            }

            .case-description {
                font-size: 0.8rem;
            }
        }

        /* 平板端优化 */
        @media (min-width: 768px) and (max-width: 1024px) {
            .cases-grid {
                column-width: 260px;
                column-gap: 1rem;
            }

            .case-item img {
                height: auto; /* 平板保持原始比例 */
                max-height: 140px; /* 平板上限 */
            }
        }


        /* 大屏幕优化 */
        @media (min-width: 1280px) {
            .cases-grid {
                column-width: 300px;
                column-gap: 1.25rem;
            }

            .case-item img {
                height: auto; /* 大屏保持原始比例 */
                max-height: 180px; /* 大屏上限 */
            }

            .case-title {
                font-size: 1rem;
            }

            .case-description {
                font-size: 0.875rem;
            }
        }

        /* 滚动优化 */
        .cases-panel {
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }

        .cases-panel::-webkit-scrollbar {
            width: 6px;
        }

        .cases-panel::-webkit-scrollbar-track {
            background: transparent;
        }

        .cases-panel::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }

        .cases-panel::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }

        /* 响应式隐藏和显示 */
        .mobile-hidden {
            display: none;
        }

        @media (min-width: 640px) {
            .mobile-hidden {
                display: block;
            }
        }

        /* 移动端特殊优化 */
        @media (max-width: 1023px) {
            .cases-panel {
                flex: 3; /* 相对权重3 */
            }

            .terminal-panel {
                flex: 2; /* 相对权重2 */
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="app-container">
        <!-- Header -->
        <div class="app-header bg-white border-b">
            <div class="px-4 lg:px-6 py-4">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                    <h1 class="text-xl lg:text-2xl font-semibold text-gray-900">封面工作站</h1>
                    <div class="flex items-center space-x-2 lg:space-x-3">
                        <span class="text-sm text-gray-600 hidden sm:inline">MCP:</span>
                        <span id="mcp-status-badge" class="px-2 lg:px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">未就绪</span>
                        <a href="/mcp" class="px-3 lg:px-4 py-1.5 bg-white border border-gray-300 text-gray-900 rounded-lg hover:bg-gray-50 transition-colors text-sm">
                            ⚙️ 管理
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel: Cases Library -->
            <div class="cases-panel">
                <div class="p-4 lg:p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <span class="text-xl mr-2">📚</span>
                            <h2 class="text-lg font-semibold text-gray-900">案例库</h2>
                        </div>
                    </div>

                    <!-- Cases Grid - 响应式网格 -->
                    <div id="cases-grid" class="cases-grid mb-6">
                        <!-- Cases will be loaded dynamically -->
                    </div>

                    <!-- User Requirements -->
                    <div class="border-t pt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">用户需求描述</label>
                        <textarea
                            id="user-requirements"
                            rows="4"
                            placeholder="请描述您的具体需求，比如：风格偏好、颜色要求、特殊元素等..."
                            class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        ></textarea>

                        <div class="flex justify-end mt-4">
                            <button
                                id="agent-generate-btn"
                                class="px-6 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors font-medium"
                            >
                                🎨 生成
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Terminal -->
            <div class="terminal-panel">
                <div class="p-4 lg:p-6 flex-1 flex flex-col">
                    <div class="flex items-center mb-4">
                        <span class="text-xl mr-2">💻</span>
                        <h2 class="text-lg font-semibold text-gray-900">终端</h2>
                        <div class="ml-auto flex items-center space-x-2">
                            <span class="text-xs text-gray-500">Claude</span>
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        </div>
                    </div>
                    <div class="terminal-container flex-1">
                        <div class="bg-gray-100 px-4 py-2 flex items-center justify-between border-b border-gray-200">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            </div>
                            <div class="flex items-center gap-4 min-w-0">
                                <span class="text-xs text-gray-600 whitespace-nowrap">Claude Terminal</span>
                                <div class="hidden sm:flex items-center gap-2">
                                    <input id="global-output-dir-input" type="text" placeholder="/Users/you/Pictures" class="text-xs px-2 py-1 border rounded w-56" />
                                    <button id="save-global-output-dir" class="text-xs px-2 py-1 border rounded hover:bg-gray-50">保存</button>
                                </div>
                            </div>
                        </div>
                        <div class="terminal-body p-2">
                            <div id="terminal"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Section: Results Gallery -->
        <div class="bg-white border-t">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <span class="text-xl mr-2">🖼️</span>
                        <h2 class="text-lg font-semibold text-gray-900">Agent生成结果</h2>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button id="refresh-gallery" class="px-3 py-1.5 text-sm border rounded-lg hover:bg-gray-50 transition-colors">
                            🔄 刷新
                        </button>
                        <button id="open-folder" class="px-3 py-1.5 text-sm border rounded-lg hover:bg-gray-50 transition-colors">
                            📁 打开文件夹
                        </button>
                    </div>
                </div>

                <!-- Image Gallery -->
                <div id="results-gallery" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 results-gallery">
                    <!-- Results will be loaded here automatically -->
                    <div class="text-center text-gray-500 col-span-full py-8">
                        <span class="text-4xl mb-2 block">🎨</span>
                        <p class="text-sm">生成的结果将自动显示在这里</p>
                        <p class="text-xs text-gray-400 mt-1">按时间排序，最新的在前</p>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- MCP Manager Modal -->
        <div id="mcp-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-hidden">
                <div class="px-6 py-4 border-b">
                    <h3 class="text-lg font-semibold">MCP 配置管理</h3>
                </div>
                <div class="p-6 overflow-y-auto max-h-[70vh]">
                    <!-- MCP Configurations -->
                    <div class="space-y-6">
                        <!-- APICore Configuration -->
                        <div class="border rounded-lg p-4">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-medium flex items-center">
                                    <span class="text-xl mr-2">📦</span>
                                    jimeng-apicore
                                </h4>
                                <span id="apicore-status" class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">未检测</span>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                    <input 
                                        type="password" 
                                        id="apicore-api-key" 
                                        placeholder="sk-xxxxxxxxxxxxxxxx"
                                        class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                    <p class="mt-1 text-xs text-gray-500">
                                        获取API Key: <a href="https://api.apicore.ai" target="_blank" class="text-blue-600 hover:underline">https://api.apicore.ai</a>
                                    </p>
                                </div>
                                <div class="text-xs text-gray-500">输出目录由首页顶部的“输出目录”统一管理</div>
                                <div class="flex gap-2 mt-3">
                                    <button onclick="saveMCPConfig('apicore')" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors">
                                        保存配置
                                    </button>
                                    <button onclick="testMCPConfig('apicore')" class="px-3 py-1.5 border text-sm rounded hover:bg-gray-50 transition-colors">
                                        测试连接
                                    </button>
                                    <button onclick="installMCP('jimeng-apicore')" class="px-3 py-1.5 border text-sm rounded hover:bg-gray-50 transition-colors">
                                        安装/更新
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- VolcEngine Configuration -->
                        <div class="border rounded-lg p-4">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-medium flex items-center">
                                    <span class="text-xl mr-2">📦</span>
                                    jimeng-volcengine
                                </h4>
                                <span id="volcengine-status" class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">未检测</span>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                    <input 
                                        type="password" 
                                        id="volcengine-api-key" 
                                        placeholder="sk-xxxxxxxxxxxxxxxx"
                                        class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                    <p class="mt-1 text-xs text-gray-500">
                                        获取API Key: <a href="https://console.volcengine.com" target="_blank" class="text-blue-600 hover:underline">https://console.volcengine.com</a>
                                    </p>
                                </div>
                                <div class="text-xs text-gray-500">输出目录由首页顶部的“输出目录”统一管理</div>
                                <div class="flex gap-2 mt-3">
                                    <button onclick="saveMCPConfig('volcengine')" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors">
                                        保存配置
                                    </button>
                                    <button onclick="testMCPConfig('volcengine')" class="px-3 py-1.5 border text-sm rounded hover:bg-gray-50 transition-colors">
                                        测试连接
                                    </button>
                                    <button onclick="installMCP('jimeng-volcengine')" class="px-3 py-1.5 border text-sm rounded hover:bg-gray-50 transition-colors">
                                        安装/更新
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <h5 class="font-medium text-sm text-gray-700 mb-2">📌 配置说明</h5>
                        <ol class="text-xs text-gray-600 space-y-1 list-decimal list-inside">
                            <li>点击"安装/更新"安装对应的MCP</li>
                            <li>输入 API Key（输出目录在首页顶部统一设置）</li>
                            <li>点击"保存配置"保存到本地配置文件</li>
                            <li>点击"测试连接"验证配置是否正确</li>
                            <li>配置成功后即可使用即梦AI生成图片</li>
                        </ol>
                    </div>
                </div>
                <div class="px-6 py-4 border-t flex justify-between">
                    <button id="mcp-view-config" class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition-colors text-sm">
                        查看配置文件
                    </button>
                    <div class="flex space-x-3">
                        <button id="mcp-close-btn" class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition-colors">
                            关闭
                        </button>
                        <button id="mcp-refresh-btn" class="px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors">
                            刷新状态
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="/js/covers-data.js"></script>
    <script src="/js/app.js"></script>
    <script src="/js/terminal.js"></script>
    <script src="/js/gui-config.js"></script>
    <script src="/js/mcp-manager.js"></script>
    <script>
        // 统一数据源配置
        const STORAGE_KEY = 'coverTemplatesData';
        let selectedCase = '1'; // Default selection
        
        // 获取案例数据（直接使用covers-data.js文件）
        function getCoverTemplates() {
            // 直接使用covers-data.js中的数据
            return window.coverTemplates || {};
        }


        // 动态生成案例网格
        function generateCasesGrid() {
            const coverTemplates = getCoverTemplates(); // 使用最新数据
            const casesGrid = document.getElementById('cases-grid');
            
            let html = '';
            Object.keys(coverTemplates).forEach((id, index) => {
                const template = coverTemplates[id];
                
                html += `
                    <div class="case-item cursor-pointer rounded-lg p-3" data-case="${id}">
                        <div class="rounded mb-2 flex items-center justify-center">
                            <img src="${template.coverImage}" alt="${template.name}" class="w-full h-auto object-contain rounded" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <span class="text-sm hidden">${id}</span>
                        </div>
                        <p class="text-xs text-gray-600 text-center">${template.name}</p>
                    </div>
                `;
            });
            
            casesGrid.innerHTML = html;
            
            // 重新绑定事件
            document.querySelectorAll('.case-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    document.querySelectorAll('.case-item').forEach(i => i.classList.remove('selected'));
                    e.currentTarget.classList.add('selected');
                    selectedCase = e.currentTarget.dataset.case;
                });
            });
            
            // 设置默认选择（选择第一个可用案例）
            const firstCase = Object.keys(coverTemplates)[0];
            if (firstCase) {
                selectedCase = firstCase;
                document.querySelector(`.case-item[data-case="${firstCase}"]`)?.classList.add('selected');
            }
        }
        
        // 不再需要监听localStorage，数据从服务器文件读取
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 直接生成案例网格，不需要初始化localStorage
            generateCasesGrid();
        });


        // 防止重复提交的标志
        let isGenerating = false;
        
        // Agent generate button
        document.getElementById('agent-generate-btn').addEventListener('click', async () => {
            // 防止重复点击
            if (isGenerating) {
                console.log('正在生成中，请稍候...');
                return;
            }
            
            const userRequirements = document.getElementById('user-requirements').value.trim();
            const coverTemplates = getCoverTemplates(); // 获取最新数据
            const template = coverTemplates[selectedCase];
            
            if (!template) {
                alert('请选择一个案例');
                return;
            }
            
            // 设置生成状态
            isGenerating = true;
            const btn = document.getElementById('agent-generate-btn');
            btn.disabled = true;
            btn.textContent = '⏳ 生成中...';
            
            // 解析输出目录（从后端解析好的目录获取）
            let outputDir = '';
            try {
                const r = await fetch('/api/output-dir');
                const j = await r.json();
                if (j && j.outputDir) {
                    outputDir = j.outputDir;
                }
            } catch (e) {
                console.warn('无法获取输出目录，将继续执行:', e);
            }

            // 生成一个目录命令，供Agent执行（提示用途）
            const dirCmd = outputDir ? `cd \"${outputDir}\"` : '';

            // 发送给后端
            if (window.socket) {
                window.socket.emit('jimeng:generate', {
                    prompt: template.prompt || '',
                    case: selectedCase,
                    userRequirements: userRequirements,
                    outputDir,
                    dirCmd
                });
            }
            
            // 5秒后恢复按钮状态
            setTimeout(() => {
                isGenerating = false;
                btn.disabled = false;
                btn.textContent = '🎨 生成';
            }, 5000);
        });
        

        // Gallery refresh
        document.getElementById('refresh-gallery').addEventListener('click', () => {
            loadGalleryImages();
        });

        // Chat functionality removed - using cases library instead

        // Open folder
        document.getElementById('open-folder').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/open-folder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const result = await response.json();
                if (!result.success) {
                    console.error('Failed to open folder:', result.error);
                }
            } catch (error) {
                console.error('Error opening folder:', error);
            }
        });

        // Load gallery images from MCP output directory
        async function loadGalleryImages() {
            const gallery = document.getElementById('results-gallery');
            
            try {
                const response = await fetch(`/api/gallery`);
                const result = await response.json();
                const files = result.files || [];

                // 显示错误信息（success 为 false）
                if (result && result.success === false) {
                    console.warn('Gallery error:', result.error, 'outputDir:', result.outputDir);
                    gallery.innerHTML = `
                        <div class="text-center text-gray-500 py-8 col-span-full">
                            <span class="text-4xl mb-2 block">⚠️</span>
                            <p class="text-sm">无法加载结果</p>
                            <p class="text-xs text-gray-400 mt-1">${result.error || '未知错误'}</p>
                            <p class="text-xs text-gray-400 mt-2">输出目录: ${result.outputDir || '未配置'}</p>
                        </div>
                    `;
                    return;
                }

                if (files.length > 0) {
                    gallery.innerHTML = '';
                    gallery.className = 'grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 results-gallery';

                    // 显示文件（图片或HTML）
                    files.forEach(item => {
                        // 统一容器
                        const container = document.createElement('div');
                        container.className = 'relative group cursor-pointer';

                        if (item.type === 'image') {
                            const img = document.createElement('img');
                            img.src = item.url;
                            img.alt = item.name;
                            img.className = 'w-full object-contain rounded-lg';
                            img.loading = 'lazy';
                            container.appendChild(img);
                        } else if (item.type === 'html') {
                            // HTML 文件卡片样式
                            const card = document.createElement('div');
                            card.className = 'w-full rounded-lg border border-gray-200 p-3 flex items-center justify-between hover:border-blue-400 transition-colors bg-white';

                            const left = document.createElement('div');
                            left.className = 'flex items-center space-x-2 overflow-hidden';
                            const icon = document.createElement('span');
                            icon.textContent = '🌐';
                            const name = document.createElement('span');
                            name.className = 'text-sm text-gray-700 truncate';
                            name.textContent = item.name;
                            left.appendChild(icon);
                            left.appendChild(name);

                            const openBtn = document.createElement('button');
                            openBtn.className = 'text-xs px-2 py-1 border rounded hover:bg-gray-50';
                            openBtn.textContent = '打开';

                            card.appendChild(left);
                            card.appendChild(openBtn);
                            container.appendChild(card);

                            // 点击打开
                            container.addEventListener('click', () => {
                                window.open(item.url, '_blank');
                            });
                        }

                        // 时间标签
                        const timeLabel = document.createElement('div');
                        timeLabel.className = 'absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 rounded-b-lg opacity-0 group-hover:opacity-100 transition-opacity';
                        const date = new Date(item.mtime);
                        timeLabel.textContent = date.toLocaleString('zh-CN', {
                            month: 'numeric',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        container.appendChild(timeLabel);
                        gallery.appendChild(container);
                    });
                    
                    // 显示输出目录信息
                    const dirInfo = document.createElement('div');
                    dirInfo.className = 'text-center text-xs text-gray-500 mt-4 col-span-full';
                    dirInfo.textContent = `输出目录: ${result.outputDir}`;
                    gallery.appendChild(dirInfo);
                } else if (result.files && result.files.length === 0) {
                    gallery.innerHTML = `
                        <div class="text-center text-gray-500 py-8 col-span-full">
                            <span class="text-4xl mb-2 block">🎨</span>
                            <p class="text-sm">暂无生成的结果</p>
                            <p class="text-xs text-gray-400 mt-1">生成的结果将自动显示在这里</p>
                            <p class="text-xs text-gray-400 mt-2">输出目录: ${result.outputDir || '未配置'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载图片失败:', error);
                gallery.innerHTML = `
                    <div class="text-center text-gray-500 py-8 col-span-full">
                        <span class="text-4xl mb-2 block">❌</span>
                        <p class="text-sm">加载图片失败</p>
                        <p class="text-xs text-gray-400 mt-1">${error.message}</p>
                    </div>
                `;
            }
        }
        // 页面加载时加载图片
        async function updateOutputDirDisplay() {
            try {
                const r = await fetch('/api/output-dir');
                const j = await r.json();
                const input = document.getElementById('global-output-dir-input');
                if (input) {
                    input.value = (j && j.sources && j.sources.configOutputDir) ? j.sources.configOutputDir : (j.outputDir || '');
                    input.title = input.value;
                }
            } catch {}
        }

        loadGalleryImages();
        updateOutputDirDisplay();
        
        // Auto-refresh gallery every 10 seconds
        setInterval(() => { loadGalleryImages(); updateOutputDirDisplay(); }, 10000);

        // 保存全局输出目录
        const saveBtn = document.getElementById('save-global-output-dir');
        if (saveBtn) {
            saveBtn.addEventListener('click', async () => {
                try {
                    const input = document.getElementById('global-output-dir-input');
                    const outputDir = input.value.trim();
                    const res = await fetch('/api/output-dir', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ outputDir })
                    });

                    const ct = res.headers.get('content-type') || '';
                    let j;
                    if (ct.includes('application/json')) {
                        j = await res.json();
                    } else {
                        const t = await res.text();
                        throw new Error(`服务器返回非JSON: ${t.slice(0, 120)}...`);
                    }

                    if (!j.success) throw new Error(j.error || '保存失败');
                    await updateOutputDirDisplay();
                    await loadGalleryImages();
                } catch (e) {
                    console.error('保存输出目录失败:', e);
                    alert('保存输出目录失败: ' + (e.message || e));
                }
            });
        }
    </script>
</body>
</html>
