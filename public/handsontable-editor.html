<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handsontable æ•°æ®ç¼–è¾‘å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.1.0/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable@14.1.0/dist/handsontable.full.min.js"></script>
    <style>
        .hot-container {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        .handsontable .ht_master .wtHolder {
            background: white;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">ğŸ“Š Handsontable æ•°æ®ç¼–è¾‘å™¨</h1>
                        <p class="text-sm text-gray-600 mt-1">åƒExcelä¸€æ ·ç¼–è¾‘å°é¢æ¡ˆä¾‹æ•°æ®</p>
                    </div>
                    <div class="flex space-x-3">
                        <button id="load-data" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            ğŸ“¥ ä»æœåŠ¡å™¨åŠ è½½
                        </button>
                        <button id="add-batch" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            â• æ‰¹é‡æ·»åŠ 10è¡Œ
                        </button>
                        <button id="import-json" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            ğŸ“‚ å¯¼å…¥JSON
                        </button>
                        <button id="export-js" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                            ğŸ’¾ ä¿å­˜åˆ°æœåŠ¡å™¨
                        </button>
                    </div>
                </div>
                
                <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
                <input type="file" id="file-input" accept=".json" style="display: none;">
                
                <!-- æ“ä½œæç¤º -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="font-medium text-blue-800 mb-2">ğŸ’¡ ä½¿ç”¨æŠ€å·§ï¼š</h3>
                    <div class="text-sm text-blue-700 grid grid-cols-2 gap-2">
                        <div>â€¢ Tab/Enter: å¿«é€Ÿåˆ‡æ¢å•å…ƒæ ¼</div>
                        <div>â€¢ Ctrl+C/V: å¤åˆ¶ç²˜è´´ï¼ˆæ”¯æŒExcelï¼‰</div>
                        <div>â€¢ å³é”®èœå•: æ’å…¥/åˆ é™¤è¡Œ</div>
                        <div>â€¢ è‡ªåŠ¨ä¿å­˜: ä¿®æ”¹åè‡ªåŠ¨å­˜å‚¨åˆ°æœ¬åœ°</div>
                    </div>
                </div>
            </div>

            <!-- Handsontable Container -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">æ•°æ®è¡¨æ ¼</h2>
                    <div class="text-sm text-gray-500">
                        <span id="row-count">0</span> è¡Œæ•°æ®
                    </div>
                </div>
                
                <div id="handsontable-container" class="hot-container" style="width: 100%; height: 600px;"></div>
            </div>
            
            <!-- æ•°æ®é¢„è§ˆ -->
            <div class="bg-white rounded-lg shadow-sm border p-6 mt-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">JSONæ•°æ®é¢„è§ˆ</h2>
                    <button id="toggle-preview" class="px-3 py-1 text-sm border rounded hover:bg-gray-50">
                        æ˜¾ç¤º/éšè—
                    </button>
                </div>
                <pre id="json-preview" class="bg-gray-900 text-green-400 p-4 rounded-lg overflow-auto text-xs max-h-60 hidden"></pre>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let hot;
        const STORAGE_KEY = 'coverTemplatesData';
        
        // åˆå§‹åŒ–Handsontable
        function initHandsontable() {
            const container = document.getElementById('handsontable-container');
            
            // åˆå§‹æ•°æ®
            const data = [
                {id: '1', name: 'è‡ªç„¶é£æ™¯', coverImage: '/covers/1.jpg', prompt: 'é£æ™¯æ‘„å½±é£æ ¼ï¼Œå±•ç°å¤§è‡ªç„¶çš„å£®ç¾æ™¯è‰²ã€‚åŒ…å«å±±è„‰ã€æ¹–æ³Šã€æ£®æ—ç­‰è‡ªç„¶å…ƒç´ ï¼Œè‰²å½©å±‚æ¬¡ä¸°å¯Œï¼Œå…‰å½±è‡ªç„¶ï¼Œ16:9æ¨ªç‰ˆæ„å›¾ã€‚photorealistic, landscape photography, natural lighting, cinematic, high resolution'},
                {id: '2', name: 'äººç‰©è‚–åƒ', coverImage: '/covers/2.jpg', prompt: 'ä¸“ä¸šäººåƒæ‘„å½±é£æ ¼ï¼Œæ³¨é‡é¢éƒ¨ç»†èŠ‚å’Œæƒ…æ„Ÿè¡¨è¾¾ã€‚é‡‡ç”¨æµ…æ™¯æ·±è™šåŒ–èƒŒæ™¯ï¼Œçªå‡ºä¸»ä½“äººç‰©ï¼Œå…‰å½±æŸ”å’Œè‡ªç„¶ã€‚3:4ç«–ç‰ˆæ„å›¾ã€‚portrait photography, professional lighting, bokeh background, detailed facial features'}
            ];
            
            hot = new Handsontable(container, {
                data: data,
                colHeaders: ['ID', 'æ¡ˆä¾‹åç§°', 'å°é¢å›¾ç‰‡', 'å®Œæ•´æç¤ºè¯'],
                columns: [
                    {
                        data: 'id',
                        type: 'text',
                        width: 60,
                        className: 'text-center font-mono'
                    },
                    {
                        data: 'name',
                        type: 'text',
                        width: 120
                    },
                    {
                        data: 'coverImage',
                        type: 'text',
                        width: 150,
                        className: 'text-xs text-blue-600'
                    },
                    {
                        data: 'prompt',
                        type: 'text',
                        width: 400,
                        renderer: function(instance, td, row, col, prop, value, cellProperties) {
                            Handsontable.renderers.TextRenderer.apply(this, arguments);
                            td.style.whiteSpace = 'pre-wrap';
                            td.style.fontSize = '12px';
                            td.style.lineHeight = '1.4';
                            td.style.padding = '8px';
                            
                            // é™åˆ¶æ˜¾ç¤ºé•¿åº¦
                            if (value && value.length > 100) {
                                td.innerHTML = value.substring(0, 100) + '...';
                                td.title = value; // å®Œæ•´å†…å®¹ä½œä¸ºtooltip
                            }
                        }
                    }
                ],
                rowHeaders: true,
                width: '100%',
                height: 600,
                licenseKey: 'non-commercial-and-evaluation',
                stretchH: 'last',
                manualRowResize: true,
                manualColumnResize: true,
                contextMenu: {
                    items: {
                        'row_above': {
                            name: 'åœ¨ä¸Šæ–¹æ’å…¥è¡Œ'
                        },
                        'row_below': {
                            name: 'åœ¨ä¸‹æ–¹æ’å…¥è¡Œ'
                        },
                        'remove_row': {
                            name: 'åˆ é™¤è¡Œ'
                        },
                        'separator1': Handsontable.plugins.ContextMenu.SEPARATOR,
                        'copy': {
                            name: 'å¤åˆ¶'
                        },
                        'cut': {
                            name: 'å‰ªåˆ‡'
                        }
                    }
                },
                afterChange: function(changes, source) {
                    if (source !== 'loadData') {
                        autoSave();
                        updatePreview();
                        updateRowCount();
                    }
                },
                afterCreateRow: function() {
                    autoSave();
                    updateRowCount();
                },
                afterRemoveRow: function() {
                    autoSave();
                    updateRowCount();
                }
            });
            
            updateRowCount();
            updatePreview();
        }
        
        // è‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼Œæš‚æ—¶å…³é—­é¿å…é¢‘ç¹è¯·æ±‚ï¼‰
        function autoSave() {
            // æš‚æ—¶å…³é—­è‡ªåŠ¨ä¿å­˜ï¼Œé¿å…æ¯æ¬¡ä¿®æ”¹éƒ½è¯·æ±‚æœåŠ¡å™¨
            // ç”¨æˆ·éœ€è¦æ‰‹åŠ¨ç‚¹å‡»"å¯¼å‡ºJSæ–‡ä»¶"æŒ‰é’®æ¥ä¿å­˜
            updatePreview();
            console.log('æ•°æ®å·²æ›´æ–°ï¼ˆéœ€æ‰‹åŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨ï¼‰');
        }
        
        // æ›´æ–°è¡Œæ•°æ˜¾ç¤º
        function updateRowCount() {
            const data = hot.getData();
            const validRows = data.filter(row => row[0]).length;
            document.getElementById('row-count').textContent = validRows;
        }
        
        // æ›´æ–°JSONé¢„è§ˆ
        function updatePreview() {
            const data = hot.getData();
            const jsonData = {};
            
            data.forEach(row => {
                if (row[0]) {
                    jsonData[row[0]] = {
                        name: row[1] || '',
                        coverImage: row[2] || `/covers/${row[0]}.jpg`,
                        prompt: row[3] || ''
                    };
                }
            });
            
            document.getElementById('json-preview').textContent = JSON.stringify(jsonData, null, 2);
        }
        
        // ä»æœåŠ¡å™¨åŠ è½½æ•°æ®
        async function loadExistingData() {
            try {
                // ä»æœåŠ¡å™¨è·å–æ•°æ®
                const response = await fetch('/api/covers');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const jsonData = result.data;
                    const data = Object.keys(jsonData).map(id => ({
                        id: id,
                        name: jsonData[id].name,
                        coverImage: jsonData[id].coverImage,
                        prompt: jsonData[id].prompt
                    }));
                    
                    if (data.length > 0) {
                        hot.loadData(data);
                        updateRowCount();
                        updatePreview();
                        alert(`âœ… å·²ä»æœåŠ¡å™¨åŠ è½½ ${data.length} æ¡æ•°æ®`);
                    } else {
                        alert('âŒ æœåŠ¡å™¨ä¸Šæ²¡æœ‰æ•°æ®');
                    }
                } else {
                    alert('âŒ åŠ è½½å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                alert('âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
            }
        }
        
        // æ‰¹é‡æ·»åŠ è¡Œ
        function addBatchRows() {
            const currentData = hot.getData();
            const lastId = Math.max(...currentData.filter(row => row[0]).map(row => parseInt(row[0]) || 0), 0);
            
            const newRows = [];
            for (let i = 1; i <= 10; i++) {
                const newId = lastId + i;
                newRows.push({
                    id: newId.toString(),
                    name: `æ–°æ¡ˆä¾‹ ${newId}`,
                    coverImage: `/covers/${newId}.jpg`,
                    prompt: 'è¯·åœ¨æ­¤å¡«å†™å®Œæ•´çš„æç¤ºè¯ï¼ŒåŒ…å«æè¿°ã€å°ºå¯¸ã€é£æ ¼ç­‰ä¿¡æ¯...'
                });
            }
            
            const allData = [...hot.getSourceData(), ...newRows];
            hot.loadData(allData);
            
            alert(`âœ… å·²æ·»åŠ  10 è¡Œæ–°æ•°æ®`);
        }
        
        // å¯¼å…¥JSONæ–‡ä»¶
        function importJSON() {
            document.getElementById('file-input').click();
        }
        
        // å¤„ç†æ–‡ä»¶å¯¼å…¥
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    const data = Object.keys(jsonData).map(id => ({
                        id: id,
                        name: jsonData[id].name || '',
                        coverImage: jsonData[id].coverImage || `/covers/${id}.jpg`,
                        prompt: jsonData[id].prompt || ''
                    }));
                    
                    hot.loadData(data);
                    updateRowCount();
                    updatePreview();
                    alert(`âœ… æˆåŠŸå¯¼å…¥ ${data.length} æ¡æ•°æ®`);
                } catch (error) {
                    alert('âŒ JSONæ ¼å¼é”™è¯¯ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // ä¿å­˜åˆ°æœåŠ¡å™¨
        async function exportJSFile() {
            const data = hot.getData();
            const jsonData = {};
            
            data.forEach(row => {
                if (row[0]) {
                    jsonData[row[0]] = {
                        name: row[1] || '',
                        coverImage: row[2] || `/covers/${row[0]}.jpg`,
                        prompt: row[3] || ''
                    };
                }
            });
            
            if (Object.keys(jsonData).length === 0) {
                alert('âŒ æ²¡æœ‰å¯ä¿å­˜çš„æ•°æ®');
                return;
            }
            
            try {
                // å‘é€æ•°æ®åˆ°æœåŠ¡å™¨
                const response = await fetch('/api/covers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ data: jsonData })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`âœ… ${result.message}\næ•°æ®å·²ä¿å­˜åˆ°æœåŠ¡å™¨ï¼`);
                } else {
                    alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + result.error);
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('âŒ æ— æ³•ä¿å­˜åˆ°æœåŠ¡å™¨');
            }
        }
        
        // åˆ‡æ¢é¢„è§ˆæ˜¾ç¤º
        function togglePreview() {
            const preview = document.getElementById('json-preview');
            preview.classList.toggle('hidden');
        }
        
        // äº‹ä»¶ç»‘å®š
        document.addEventListener('DOMContentLoaded', async function() {
            initHandsontable();
            
            // è‡ªåŠ¨åŠ è½½æœåŠ¡å™¨æ•°æ®
            await loadExistingData();
            
            document.getElementById('load-data').addEventListener('click', loadExistingData);
            document.getElementById('add-batch').addEventListener('click', addBatchRows);
            document.getElementById('import-json').addEventListener('click', importJSON);
            document.getElementById('export-js').addEventListener('click', exportJSFile);
            document.getElementById('toggle-preview').addEventListener('click', togglePreview);
            document.getElementById('file-input').addEventListener('change', handleFileImport);
        });
    </script>
</body>
</html>