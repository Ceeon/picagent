<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP ç®¡ç†ä¸­å¿ƒ - PicAgent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        }

        .terminal-container {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            overflow: hidden;
            height: 100%;
        }

        .terminal-body {
            height: calc(100% - 45px);
        }

        .checkbox-custom {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.25rem;
            background-color: white;
            cursor: pointer;
            position: relative;
        }

        .checkbox-custom:checked {
            background-color: #0f172a;
            border-color: #0f172a;
        }

        .checkbox-custom:checked::after {
            content: 'âœ“';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.875rem;
        }

        .loading {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <div class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <a href="/" class="text-gray-600 hover:text-gray-900">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                        </a>
                        <div>
                            <h1 class="text-2xl font-semibold text-gray-900">MCP ç®¡ç†ä¸­å¿ƒ</h1>
                            <p class="text-sm text-gray-500 mt-1">é…ç½®å’Œç®¡ç† Model Context Protocol æœåŠ¡</p>
                        </div>
                    </div>
                    <button id="refresh-all" class="px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors">
                        åˆ·æ–°çŠ¶æ€
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" style="height: calc(100vh - 150px);">
                <!-- Left Panel: MCP Management -->
                <div class="bg-white rounded-lg shadow-sm border overflow-y-auto">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-lg font-semibold text-gray-900">ğŸ¯ MCP é…ç½®ç®¡ç†</h2>
                            <span id="overall-status" class="px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                                æ£€æµ‹ä¸­...
                            </span>
                        </div>

                        <div class="space-y-4">
                            <!-- jimeng-apicore -->
                            <div class="border rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-lg">ğŸ“¦</span>
                                        <span class="font-medium">jimeng-apicore</span>
                                    </div>
                                    <span id="apicore-status" class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
                                        æ£€æµ‹ä¸­...
                                    </span>
                                </div>
                                
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                        <div class="flex gap-2">
                                            <input 
                                                type="password" 
                                                id="apicore-key"
                                                placeholder="sk-xxxxxxxxxxxxxxxx"
                                                class="flex-1 px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            >
                                            <button onclick="togglePassword('apicore-key')" class="px-3 py-2 border rounded-lg hover:bg-gray-50">
                                                ğŸ‘ï¸
                                            </button>
                                        </div>
                                        <p class="mt-1 text-xs text-gray-500">
                                            è·å–: <a href="https://api.apicore.ai" target="_blank" class="text-blue-600 hover:underline">api.apicore.ai</a>
                                        </p>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">è¾“å‡ºç›®å½•</label>
                                        <input 
                                            type="text" 
                                            id="apicore-dir"
                                            placeholder="/Users/yourname/Pictures"
                                            class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        >
                                    </div>
                                    
                                    <div class="flex gap-2 pt-2">
                                        <button onclick="installMCP('jimeng-apicore')" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                            é€šè¿‡ Claude é…ç½®
                                        </button>
                                        <button onclick="removeMCP('jimeng-apicore')" class="px-3 py-1.5 border border-red-300 text-red-600 text-sm rounded hover:bg-red-50">
                                            åˆ é™¤
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- jimeng-volcengine -->
                            <div class="border rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-lg">ğŸ“¦</span>
                                        <span class="font-medium">jimeng-volcengine</span>
                                    </div>
                                    <span id="volcengine-status" class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
                                        æ£€æµ‹ä¸­...
                                    </span>
                                </div>
                                
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                        <div class="flex gap-2">
                                            <input 
                                                type="password" 
                                                id="volcengine-key"
                                                placeholder="sk-xxxxxxxxxxxxxxxx"
                                                class="flex-1 px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            >
                                            <button onclick="togglePassword('volcengine-key')" class="px-3 py-2 border rounded-lg hover:bg-gray-50">
                                                ğŸ‘ï¸
                                            </button>
                                        </div>
                                        <p class="mt-1 text-xs text-gray-500">
                                            è·å–: <a href="https://console.volcengine.com" target="_blank" class="text-blue-600 hover:underline">console.volcengine.com</a>
                                        </p>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">è¾“å‡ºç›®å½•</label>
                                        <input 
                                            type="text" 
                                            id="volcengine-dir"
                                            placeholder="/Users/yourname/Pictures"
                                            class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        >
                                    </div>
                                    
                                    <div class="flex gap-2 pt-2">
                                        <button onclick="installMCP('jimeng-volcengine')" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                            é€šè¿‡ Claude é…ç½®
                                        </button>
                                        <button onclick="removeMCP('jimeng-volcengine')" class="px-3 py-1.5 border border-red-300 text-red-600 text-sm rounded hover:bg-red-50">
                                            åˆ é™¤
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Help Section -->
                            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                                <h3 class="text-sm font-medium text-blue-900 mb-2">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
                                <ol class="text-xs text-blue-700 space-y-1 list-decimal list-inside">
                                    <li>è¾“å…¥æ‚¨çš„ API Keyï¼ˆå¿…å¡«ï¼‰</li>
                                    <li>è®¾ç½®è¾“å‡ºç›®å½•ï¼ˆå¯é€‰ï¼Œé»˜è®¤ ~/Picturesï¼‰</li>
                                    <li>ç‚¹å‡»"é€šè¿‡ Claude é…ç½®"æŒ‰é’®</li>
                                    <li>Claude ä¼šè‡ªåŠ¨æ‰§è¡Œé…ç½®å‘½ä»¤</li>
                                    <li>Claude ä¼šæ™ºèƒ½å¤„ç†ä¸åŒç³»ç»Ÿçš„è·¯å¾„æ ¼å¼</li>
                                    <li>é…ç½®æˆåŠŸåå¯åœ¨ Claude Desktop ä¸­ä½¿ç”¨</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Terminal -->
                <div class="bg-white rounded-lg shadow-sm border" style="display: flex; flex-direction: column;">
                    <div class="p-6 flex-1" style="display: flex; flex-direction: column;">
                        <div class="flex items-center mb-4">
                            <span class="text-xl mr-2">ğŸ’»</span>
                            <h2 class="text-lg font-semibold text-gray-900">MCP é…ç½®ç»ˆç«¯</h2>
                            <div class="ml-auto flex items-center space-x-2">
                                <span class="text-xs text-gray-500">Claudeå·²å¯åŠ¨</span>
                                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            </div>
                        </div>
                        <div class="terminal-container flex-1">
                            <div class="bg-gray-100 px-4 py-2 flex items-center justify-between border-b border-gray-200">
                                <div class="flex items-center space-x-2">
                                    <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                    <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                </div>
                                <span class="text-xs text-gray-600">MCP é…ç½®ç»ˆç«¯</span>
                            </div>
                            <div class="terminal-body p-2">
                                <div id="terminal"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script>
        const socket = io();
        let term;
        let fitAddon;
        let mcpStatuses = [];
        
        // Load saved config from localStorage
        function loadSavedConfig() {
            const savedConfig = localStorage.getItem('mcp-config');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    if (config.apicore) {
                        document.getElementById('apicore-key').value = config.apicore.apiKey || '';
                        document.getElementById('apicore-dir').value = config.apicore.outputDir || '';
                    }
                    if (config.volcengine) {
                        document.getElementById('volcengine-key').value = config.volcengine.apiKey || '';
                        document.getElementById('volcengine-dir').value = config.volcengine.outputDir || '';
                    }
                } catch (e) {
                    console.error('Failed to load saved config:', e);
                }
            }
        }
        
        // Save config to localStorage
        function saveConfigToLocal() {
            const config = {
                apicore: {
                    apiKey: document.getElementById('apicore-key').value,
                    outputDir: document.getElementById('apicore-dir').value
                },
                volcengine: {
                    apiKey: document.getElementById('volcengine-key').value,
                    outputDir: document.getElementById('volcengine-dir').value
                }
            };
            localStorage.setItem('mcp-config', JSON.stringify(config));
        }

        // Initialize terminal
        function initializeTerminal() {
            term = new Terminal({
                theme: {
                    background: '#ffffff',
                    foreground: '#333333',
                    cursor: '#333333',
                    selection: 'rgba(0, 0, 0, 0.15)',
                    black: '#000000',
                    red: '#dc2626',
                    green: '#16a34a',
                    yellow: '#ca8a04',
                    blue: '#2563eb',
                    magenta: '#9333ea',
                    cyan: '#0891b2',
                    white: '#f3f4f6',
                    brightBlack: '#6b7280',
                    brightRed: '#ef4444',
                    brightGreen: '#22c55e',
                    brightYellow: '#eab308',
                    brightBlue: '#3b82f6',
                    brightMagenta: '#a855f7',
                    brightCyan: '#06b6d4',
                    brightWhite: '#f9fafb'
                },
                fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                fontSize: 16,
                lineHeight: 1.4,
                cursorBlink: true,
                convertEol: true
            });
            
            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            
            term.open(document.getElementById('terminal'));
            fitAddon.fit();
            
            socket.emit('terminal:create', {
                cols: term.cols,
                rows: term.rows
            });
            
            term.onData((data) => {
                socket.emit('terminal:write', data);
            });
            
            window.addEventListener('resize', () => {
                fitAddon.fit();
                socket.emit('terminal:resize', {
                    cols: term.cols,
                    rows: term.rows
                });
            });
        }

        // Socket event handlers
        socket.on('connect', () => {
            initializeTerminal();
            // Load saved config from localStorage first
            loadSavedConfig();
            checkAllStatus();
        });

        socket.on('terminal:data', (data) => {
            term.write(data);
        });

        socket.on('terminal:created', () => {
            // ç»ˆç«¯åˆ›å»ºåè‡ªåŠ¨å¯åŠ¨ Claude
            setTimeout(() => {
                socket.emit('terminal:write', 'claude\r');
            }, 500);
        });

        // MCP functions
        function checkAllStatus() {
            socket.emit('mcp:check');
        }

        function installMCP(name) {
            // è·å–ç”¨æˆ·è¾“å…¥çš„é…ç½®
            const config = {};
            
            if (name === 'jimeng-apicore') {
                const keyInput = document.getElementById('apicore-key');
                const dirInput = document.getElementById('apicore-dir');
                
                // å¿…é¡»æä¾› API Key
                if (!keyInput || !keyInput.value) {
                    alert('è¯·å…ˆè¾“å…¥ API Key å†å®‰è£…ï¼');
                    return;
                }
                
                config.apiKey = keyInput.value;
                config.outputDir = dirInput.value || '~/Pictures';
                
            } else if (name === 'jimeng-volcengine') {
                const keyInput = document.getElementById('volcengine-key');
                const dirInput = document.getElementById('volcengine-dir');
                
                // å¿…é¡»æä¾› API Key
                if (!keyInput || !keyInput.value) {
                    alert('è¯·å…ˆè¾“å…¥ API Key å†å®‰è£…ï¼');
                    return;
                }
                
                config.apiKey = keyInput.value;
                config.outputDir = dirInput.value || '~/Pictures';
            }
            
            // å‘é€å®‰è£…å‘½ä»¤ï¼ŒåŒ…å«ç”¨æˆ·é…ç½®
            socket.emit('mcp:install', name, config);
        }

        function removeMCP(name) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤ ${name} å—ï¼Ÿ`)) {
                // ç›´æ¥å‘é€åˆ é™¤å‘½ä»¤ï¼Œä¸åœ¨ç»ˆç«¯æ˜¾ç¤ºé¢å¤–ä¿¡æ¯
                socket.emit('mcp:remove', name);
            }
        }

        function togglePassword(id) {
            const input = document.getElementById(id);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // Status update handlers
        socket.on('mcp:status', (statuses) => {
            mcpStatuses = statuses;
            updateStatusDisplay(statuses);
        });

        function updateStatusDisplay(statuses) {
            const apicoreStatus = statuses.find(s => s.name === 'jimeng-apicore');
            const volcengineStatus = statuses.find(s => s.name === 'jimeng-volcengine');
            
            // Update individual status badges
            updateBadge('apicore-status', apicoreStatus);
            updateBadge('volcengine-status', volcengineStatus);
            
            // Update overall status
            const overallBadge = document.getElementById('overall-status');
            const hasValidMCP = (apicoreStatus?.installed && apicoreStatus?.apiKeyValid) || 
                               (volcengineStatus?.installed && volcengineStatus?.apiKeyValid);
            
            if (hasValidMCP) {
                overallBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700';
                overallBadge.textContent = 'âœ… å·²å°±ç»ª';
            } else {
                overallBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700';
                overallBadge.textContent = 'âš ï¸ éœ€é…ç½®';
            }
        }

        function updateBadge(id, status) {
            const badge = document.getElementById(id);
            if (!badge) return;
            
            if (!status) {
                badge.className = 'px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600';
                badge.textContent = 'æœªæ£€æµ‹';
            } else if (status.installed && status.apiKeyValid) {
                badge.className = 'px-2 py-1 text-xs rounded-full bg-green-100 text-green-700';
                badge.textContent = 'âœ… å·²å°±ç»ª';
            } else if (status.installed) {
                badge.className = 'px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700';
                badge.textContent = 'âš ï¸ éœ€é…ç½®';
            } else {
                badge.className = 'px-2 py-1 text-xs rounded-full bg-red-100 text-red-700';
                badge.textContent = 'âŒ æœªå®‰è£…';
            }
        }

        // Result handlers
        socket.on('mcp:install:result', (result) => {
            // å»¶è¿Ÿ1ç§’åæ›´æ–°çŠ¶æ€ï¼Œç»™Claudeæ—¶é—´æ›´æ–°é…ç½®
            setTimeout(() => {
                checkAllStatus();
            }, 1000);
        });

        socket.on('mcp:remove:result', (result) => {
            if (result.success) {
                // åˆ é™¤æˆåŠŸåï¼Œç«‹å³åœ¨æœ¬åœ°æ›´æ–°çŠ¶æ€ä¸ºæœªå®‰è£…
                const mcpName = result.mcpName || '';
                if (mcpName === 'jimeng-apicore') {
                    updateBadge('apicore-status', { installed: false, configured: false, apiKeyValid: false });
                } else if (mcpName === 'jimeng-volcengine') {
                    updateBadge('volcengine-status', { installed: false, configured: false, apiKeyValid: false });
                }
            }
            // å»¶è¿Ÿ2ç§’åé‡æ–°æ£€æŸ¥å®é™…çŠ¶æ€
            setTimeout(() => {
                checkAllStatus();
            }, 2000);
        });

        // Refresh button
        document.getElementById('refresh-all').addEventListener('click', () => {
            // ç›´æ¥åˆ·æ–°çŠ¶æ€ï¼Œä¸æ˜¾ç¤ºæç¤º
            checkAllStatus();
        });

        // Auto refresh every 10 seconds
        setInterval(checkAllStatus, 10000);
        
        // Add event listeners to save config on input change
        window.addEventListener('DOMContentLoaded', () => {
            const inputs = ['apicore-key', 'apicore-dir', 'volcengine-key', 'volcengine-dir'];
            inputs.forEach(id => {
                const elem = document.getElementById(id);
                if (elem) {
                    elem.addEventListener('blur', saveConfigToLocal);
                }
            });
            
            // Load saved config on page load
            loadSavedConfig();
        });
    </script>
</body>
</html>