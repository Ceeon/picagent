<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP ÁÆ°ÁêÜ‰∏≠ÂøÉ - PicAgent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        }

        .terminal-container {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            overflow: hidden;
            height: 100%;
        }

        .terminal-body {
            height: calc(100% - 45px);
        }

        .mcp-card {
            transition: all 0.2s ease;
        }

        .mcp-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-connected {
            background-color: #10b981;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .status-warning {
            background-color: #f59e0b;
        }

        .status-error {
            background-color: #ef4444;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <div class="bg-white border-b">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <a href="/" class="flex items-center text-gray-600 hover:text-gray-900 transition-colors">
                        ‚Üê
                    </a>
                    <button id="refresh-all" class="px-4 py-2 bg-white border border-gray-300 text-gray-900 rounded-lg hover:bg-gray-50 transition-colors">
                        Âà∑Êñ∞Áä∂ÊÄÅ
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content - 2/3ÈÖçÁΩÆÂå∫ + 1/3ÁªàÁ´ØÂå∫ -->
        <div class="flex" style="height: calc(100vh - 100px);">
            <!-- Â∑¶Âå∫ÔºöMCP ÈÖçÁΩÆ (2/3ÂÆΩÂ∫¶) -->
            <div class="w-2/3 overflow-y-auto">
                <div class="p-6">

                        <!-- ËæìÂá∫ÁõÆÂΩïÁªü‰∏ÄÁî±È¶ñÈ°µËÆæÁΩÆÔºåÊ≠§Â§Ñ‰∏çÂÜçÂ±ïÁ§∫ -->

                        <!-- MCP ÊúçÂä°ÈÖçÁΩÆ -->
                        <div class="space-y-6">

                            <!-- jimeng-apicore -->
                            <div>
                                <div class="mb-3">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <span class="text-lg">ü§ñ</span>
                                        <span class="font-medium text-gray-900">Âç≥Ê¢¶¬∑APICore</span>
                                        <a href="https://api.apicore.ai" target="_blank" class="text-xs text-blue-600 hover:underline">Áî≥ËØ∑</a>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span id="apicore-status-dot" class="status-indicator status-error"></span>
                                        <span id="apicore-status-text" class="text-xs text-gray-500">Ê£ÄÊµã‰∏≠...</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-sm text-gray-600 mb-1">API Key:</label>
                                    <div class="flex gap-2">
                                        <input
                                            type="password"
                                            id="apicore-key"
                                            placeholder="sk-xxxxxxxxxxxxxxxx"
                                            class="flex-1 px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        >
                                        <button onclick="togglePassword('apicore-key')" class="px-3 py-2 border rounded hover:bg-gray-50">üëÅÔ∏è</button>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="installMCP('jimeng-apicore')" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">ÈáçÊñ∞ÈÖçÁΩÆ</button>
                                    <button onclick="removeMCP('jimeng-apicore')" class="px-3 py-1.5 border border-red-300 text-red-600 text-sm rounded hover:bg-red-50">Âà†Èô§</button>
                                </div>
                            </div>

                            <!-- jimeng-volcengine -->
                            <div>
                                <div class="mb-3">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <span class="text-lg">ü§ñ</span>
                                        <span class="font-medium text-gray-900">Âç≥Ê¢¶¬∑ÁÅ´Â±±ÂºïÊìé</span>
                                        <a href="https://console.volcengine.com" target="_blank" class="text-xs text-blue-600 hover:underline">Áî≥ËØ∑</a>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span id="volcengine-status-dot" class="status-indicator status-error"></span>
                                        <span id="volcengine-status-text" class="text-xs text-gray-500">Ê£ÄÊµã‰∏≠...</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-sm text-gray-600 mb-1">API Key:</label>
                                    <div class="flex gap-2">
                                        <input
                                            type="password"
                                            id="volcengine-key"
                                            placeholder="sk-xxxxxxxxxxxxxxxx"
                                            class="flex-1 px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        >
                                        <button onclick="togglePassword('volcengine-key')" class="px-3 py-2 border rounded hover:bg-gray-50">üëÅÔ∏è</button>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="installMCP('jimeng-volcengine')" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">Á´ãÂç≥ÈÖçÁΩÆ</button>
                                    <button onclick="removeMCP('jimeng-volcengine')" class="px-3 py-1.5 border border-red-300 text-red-600 text-sm rounded hover:bg-red-50">Âà†Èô§</button>
                                </div>
                            </div>

                            <!-- gemini-apicore -->
                            <div>
                                <div class="mb-3">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <span class="text-lg">ü§ñ</span>
                                        <span class="font-medium text-gray-900">nano banana apicore</span>
                                        <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-xs text-blue-600 hover:underline">Áî≥ËØ∑</a>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span id="gemini-status-dot" class="status-indicator status-error"></span>
                                        <span id="gemini-status-text" class="text-xs text-gray-500">Ê£ÄÊµã‰∏≠...</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-sm text-gray-600 mb-1">API Key:</label>
                                    <div class="flex gap-2">
                                        <input
                                            type="password"
                                            id="gemini-key"
                                            placeholder="AIzaSy..."
                                            class="flex-1 px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        >
                                        <button onclick="togglePassword('gemini-key')" class="px-3 py-2 border rounded hover:bg-gray-50">üëÅÔ∏è</button>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="installMCP('gemini-apicore')" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">Á´ãÂç≥ÈÖçÁΩÆ</button>
                                    <button onclick="removeMCP('gemini-apicore')" class="px-3 py-1.5 border border-red-300 text-red-600 text-sm rounded hover:bg-red-50">Âà†Èô§</button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

            <!-- Âè≥Âå∫ÔºöÁªàÁ´ØËæìÂá∫ (1/3ÂÆΩÂ∫¶) -->
            <div class="w-1/3 flex flex-col">
                <div class="p-6 flex-1 flex flex-col">
                        <div class="flex items-center mb-4">
                            <span class="text-xl mr-2">üíª</span>
                            <h2 class="text-lg font-semibold text-gray-900">ÁªàÁ´ØÊâßË°å</h2>
                            <div class="ml-auto flex items-center space-x-2">
                                <span class="text-xs text-gray-500">Claude</span>
                                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            </div>
                        </div>
                        <div class="terminal-container flex-1">
                            <div class="bg-gray-100 px-4 py-2 flex items-center justify-between border-b border-gray-200">
                                <div class="flex items-center space-x-2">
                                    <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                    <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                </div>
                                <span class="text-xs text-gray-600">MCP ÈÖçÁΩÆÁªàÁ´Ø</span>
                            </div>
                            <div class="terminal-body p-2">
                                <div id="terminal"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script>
        const socket = io();
        let term;
        let fitAddon;
        let mcpStatuses = [];

        // Load saved config and current output dir
        async function loadSavedConfig() {
            const savedConfig = localStorage.getItem('mcp-config');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    if (config.apicore) {
                        document.getElementById('apicore-key').value = config.apicore.apiKey || '';
                    }
                    if (config.volcengine) {
                        document.getElementById('volcengine-key').value = config.volcengine.apiKey || '';
                    }
                    if (config.gemini) {
                        document.getElementById('gemini-key').value = config.gemini.apiKey || '';
                    }
                } catch (e) {
                    console.error('Failed to load saved config:', e);
                }
            }
        }

        // Save config to localStorage
        function saveConfigToLocal() {
            const config = {
                apicore: {
                    apiKey: document.getElementById('apicore-key').value
                },
                volcengine: {
                    apiKey: document.getElementById('volcengine-key').value
                },
                gemini: {
                    apiKey: document.getElementById('gemini-key').value
                }
            };
            localStorage.setItem('mcp-config', JSON.stringify(config));
        }

        // Initialize terminal
        function initializeTerminal() {
            term = new Terminal({
                theme: {
                    background: '#ffffff',
                    foreground: '#333333',
                    cursor: '#333333',
                    selection: 'rgba(0, 0, 0, 0.15)',
                    black: '#000000',
                    red: '#dc2626',
                    green: '#16a34a',
                    yellow: '#ca8a04',
                    blue: '#2563eb',
                    magenta: '#9333ea',
                    cyan: '#0891b2',
                    white: '#f3f4f6',
                    brightBlack: '#6b7280',
                    brightRed: '#ef4444',
                    brightGreen: '#22c55e',
                    brightYellow: '#eab308',
                    brightBlue: '#3b82f6',
                    brightMagenta: '#a855f7',
                    brightCyan: '#06b6d4',
                    brightWhite: '#f9fafb'
                },
                fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                fontSize: 16,
                lineHeight: 1.4,
                cursorBlink: true,
                convertEol: true
            });

            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);

            term.open(document.getElementById('terminal'));
            fitAddon.fit();

            socket.emit('terminal:create', {
                cols: term.cols,
                rows: term.rows
            });

            term.onData((data) => {
                socket.emit('terminal:write', data);
            });

            window.addEventListener('resize', () => {
                fitAddon.fit();
                socket.emit('terminal:resize', {
                    cols: term.cols,
                    rows: term.rows
                });
            });
        }

        // Socket event handlers
        socket.on('connect', () => {
            initializeTerminal();
            loadSavedConfig();
            checkAllStatus();
        });

        socket.on('terminal:data', (data) => {
            term.write(data);
        });

        socket.on('terminal:created', () => {
            // ÁªàÁ´ØÂàõÂª∫ÂêéËá™Âä®ÂêØÂä® Claude
            setTimeout(() => {
                socket.emit('terminal:write', 'claude\r');
            }, 500);
        });

        // MCP functions
        function checkAllStatus() {
            // ÂêëÊúçÂä°Âô®ËØ∑Ê±ÇÁúüÂÆûÁöÑMCPÁä∂ÊÄÅ
            socket.emit('mcp:check');
        }

        async function installMCP(name) {
            const config = {};
            let globalOutputDir = '';
            try {
                const r = await fetch('/api/output-dir');
                const j = await r.json();
                globalOutputDir = j && j.outputDir ? j.outputDir : '~/Pictures';
            } catch {
                globalOutputDir = '~/Pictures';
            }

            if (name === 'jimeng-apicore') {
                const keyInput = document.getElementById('apicore-key');

                // ÂøÖÈ°ªÊèê‰æõ API Key
                if (!keyInput || !keyInput.value) {
                    alert('ËØ∑ÂÖàËæìÂÖ• API Key ÂÜçÂÆâË£ÖÔºÅ');
                    return;
                }

                config.apiKey = keyInput.value;
                config.outputDir = globalOutputDir;

            } else if (name === 'jimeng-volcengine') {
                const keyInput = document.getElementById('volcengine-key');

                // ÂøÖÈ°ªÊèê‰æõ API Key
                if (!keyInput || !keyInput.value) {
                    alert('ËØ∑ÂÖàËæìÂÖ• API Key ÂÜçÂÆâË£ÖÔºÅ');
                    return;
                }

                config.apiKey = keyInput.value;
                config.outputDir = globalOutputDir;

            } else if (name === 'gemini-apicore') {
                const keyInput = document.getElementById('gemini-key');

                // ÂøÖÈ°ªÊèê‰æõ API Key
                if (!keyInput || !keyInput.value) {
                    alert('ËØ∑ÂÖàËæìÂÖ• API Key ÂÜçÂÆâË£ÖÔºÅ');
                    return;
                }

                config.apiKey = keyInput.value;
                config.outputDir = globalOutputDir;
            }

            // ÂèëÈÄÅÂÆâË£ÖÂëΩ‰ª§ÔºåÂåÖÂê´Áî®Êà∑ÈÖçÁΩÆ
            socket.emit('mcp:install', name, config);
        }

        function removeMCP(name) {
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ ${name} ÂêóÔºü`)) {
                socket.emit('mcp:remove', name);
            }
        }

        function togglePassword(id) {
            const input = document.getElementById(id);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // Status update handlers
        socket.on('mcp:status', (statuses) => {
            mcpStatuses = statuses;
            updateStatusDisplay(statuses);
        });

        function updateStatusDisplay(statuses) {
            const apicoreStatus = statuses.find(s => s.name === 'jimeng-apicore');
            const volcengineStatus = statuses.find(s => s.name === 'jimeng-volcengine');
            const geminiStatus = statuses.find(s => s.name === 'gemini-apicore');

            // Update individual status badges and dots
            updateStatusBadgeAndDot('apicore', apicoreStatus);
            updateStatusBadgeAndDot('volcengine', volcengineStatus);
            updateStatusBadgeAndDot('gemini', geminiStatus);

            // Update overall status
            const overallBadge = document.getElementById('overall-status');
            const hasValidMCP = (apicoreStatus?.installed && apicoreStatus?.apiKeyValid) ||
                               (volcengineStatus?.installed && volcengineStatus?.apiKeyValid) ||
                               (geminiStatus?.installed && geminiStatus?.apiKeyValid);

            if (hasValidMCP) {
                overallBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700';
                overallBadge.textContent = '‚úÖ Â∑≤Â∞±Áª™';
            } else {
                overallBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700';
                overallBadge.textContent = '‚ö†Ô∏è ÈúÄÈÖçÁΩÆ';
            }
        }

        function updateStatusBadgeAndDot(prefix, status) {
            const dot = document.getElementById(`${prefix}-status-dot`);
            const text = document.getElementById(`${prefix}-status-text`);

            if (!dot || !text) return;

            if (!status) {
                dot.className = 'status-indicator status-error';
                text.textContent = 'Êú™Ê£ÄÊµã';
            } else if (!status.installed) {
                dot.className = 'status-indicator status-error';
                text.textContent = 'Êú™ÂÆâË£Ö';
            } else if (status.installed && status.apiKeyValid) {
                dot.className = 'status-indicator status-connected';
                text.textContent = 'Â∑≤ËøûÊé•';
            } else {
                dot.className = 'status-indicator status-warning';
                text.textContent = 'Êú™ÈÖçÁΩÆ';
            }

            // API KeyËæìÂÖ•Ê°ÜÂíåÊåâÈíÆÊ∞∏ËøúÊòæÁ§∫Ôºå‰∏çÈöêËóèÔºÅ
        }

        // Result handlers
        socket.on('mcp:install:result', (result) => {
            // Âª∂Ëøü1ÁßíÂêéÊõ¥Êñ∞Áä∂ÊÄÅÔºåÁªôClaudeÊó∂Èó¥Êõ¥Êñ∞ÈÖçÁΩÆ
            setTimeout(() => {
                checkAllStatus();
            }, 1000);
        });

        socket.on('mcp:remove:result', (result) => {
            if (result.success) {
                // Âà†Èô§ÊàêÂäüÂêéÔºåÁ´ãÂç≥Âú®Êú¨Âú∞Êõ¥Êñ∞Áä∂ÊÄÅ‰∏∫Êú™ÂÆâË£Ö
                const mcpName = result.mcpName || '';
                if (mcpName === 'jimeng-apicore') {
                    updateStatusBadgeAndDot('apicore', { installed: false, configured: false, apiKeyValid: false });
                } else if (mcpName === 'jimeng-volcengine') {
                    updateStatusBadgeAndDot('volcengine', { installed: false, configured: false, apiKeyValid: false });
                } else if (mcpName === 'gemini-apicore') {
                    updateStatusBadgeAndDot('gemini', { installed: false, configured: false, apiKeyValid: false });
                }
            }
            // Âª∂Ëøü2ÁßíÂêéÈáçÊñ∞Ê£ÄÊü•ÂÆûÈôÖÁä∂ÊÄÅ
            setTimeout(() => {
                checkAllStatus();
            }, 2000);
        });

        // Refresh button
        document.getElementById('refresh-all').addEventListener('click', () => {
            checkAllStatus();
        });

        // Add event listeners to save config on input change
        window.addEventListener('DOMContentLoaded', () => {
            const inputs = ['apicore-key', 'volcengine-key', 'gemini-key'];
            inputs.forEach(id => {
                const elem = document.getElementById(id);
                if (elem) {
                    elem.addEventListener('blur', saveConfigToLocal);
                }
            });

            // Load saved config on page load
            loadSavedConfig();
        });
    </script>
</body>
</html>
